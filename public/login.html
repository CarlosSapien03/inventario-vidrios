<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Inventario de Vidrios</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="login">
    <div class="container">
      <h1>Inventario de Vidrios</h1>

      <!-- Formulario de Login -->
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required />
        </div>
        <div class="form-group">
          <label for="loginPassword">Contraseña</label>
          <input type="password" id="loginPassword" required />
        </div>
        <button type="submit" class="btn">Iniciar Sesión</button>
        <div id="loginMessage" class="message"></div>
      </form>

      <!-- Formulario de Registro -->
      <form id="registerForm" class="hidden">
        <div class="form-group">
          <label for="registerNombre">Nombre</label>
          <input type="text" id="registerNombre" required />
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required />
        </div>
        <div class="form-group">
          <label for="registerPassword">Contraseña</label>
          <input type="password" id="registerPassword" required minlength="6" />
        </div>
        <button type="submit" class="btn">Registrarse</button>
        <div id="registerMessage" class="message"></div>
      </form>

      <div class="toggle-form">
        <span id="toggleText">¿No tienes cuenta? </span>
        <a href="#" id="toggleLink">Regístrate aquí</a>
      </div>
    </div>

    <script>
      const loginForm = document.getElementById("loginForm");
      const registerForm = document.getElementById("registerForm");
      const toggleLink = document.getElementById("toggleLink");
      const toggleText = document.getElementById("toggleText");

      // Alternar entre login y registro
      toggleLink.addEventListener("click", (e) => {
        e.preventDefault();
        loginForm.classList.toggle("hidden");
        registerForm.classList.toggle("hidden");

        if (loginForm.classList.contains("hidden")) {
          toggleText.textContent = "¿Ya tienes cuenta? ";
          toggleLink.textContent = "Inicia sesión aquí";
        } else {
          toggleText.textContent = "¿No tienes cuenta? ";
          toggleLink.textContent = "Regístrate aquí";
        }
      });

      // Manejar login
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const messageDiv = document.getElementById("loginMessage");

        try {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            messageDiv.className = "message success";
            messageDiv.textContent = "¡Login exitoso! Redirigiendo...";
            messageDiv.style.display = "block";

            // Guardar token en localStorage
            localStorage.setItem("session", JSON.stringify(data.session));

            // Redirigir al dashboard
            setTimeout(() => {
              window.location.href = "/dashboard.html";
            }, 1500);
          } else {
            messageDiv.className = "message error";
            messageDiv.textContent = data.error || "Error al iniciar sesión";
            messageDiv.style.display = "block";
          }
        } catch (error) {
          messageDiv.className = "message error";
          messageDiv.textContent = "Error de conexión con el servidor";
          messageDiv.style.display = "block";
        }
      });

      // Manejar registro
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const nombre = document.getElementById("registerNombre").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const messageDiv = document.getElementById("registerMessage");

        try {
          const response = await fetch("/api/auth/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nombre, email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            messageDiv.className = "message success";
            messageDiv.textContent =
              "¡Registro exitoso! Revisa tu email para confirmar.";
            messageDiv.style.display = "block";

            // Limpiar formulario
            registerForm.reset();

            // Cambiar a login después de 2 segundos
            setTimeout(() => {
              toggleLink.click();
            }, 2000);
          } else {
            messageDiv.className = "message error";
            messageDiv.textContent = data.error || "Error al registrarse";
            messageDiv.style.display = "block";
          }
        } catch (error) {
          messageDiv.className = "message error";
          messageDiv.textContent = "Error de conexión con el servidor";
          messageDiv.style.display = "block";
        }
      });
    </script>
  </body>
</html>
